<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin Avancé – Comparateur IA</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    
    :root {
      --bg-primary: #0f172a;
      --bg-secondary: #1e293b;
      --bg-card: #334155;
      --accent-primary: #8b5cf6;
      --accent-secondary: #a78bfa;
      --text-primary: #f8fafc;
      --text-secondary: #cbd5e1;
      --text-muted: #94a3b8;
      --success: #10b981;
      --warning: #f59e0b;
      --danger: #ef4444;
      --border: #475569;
      --shadow: rgba(0, 0, 0, 0.3);
      --transition-smooth: cubic-bezier(0.4, 0, 0.2, 1);
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, var(--bg-primary) 0%, #1a1f35 100%);
      color: var(--text-primary);
      padding: 24px;
      min-height: 100vh;
    }

    /* ===== HEADER ===== */
    header {
      background: var(--bg-secondary);
      border-radius: 16px;
      padding: 28px;
      box-shadow: 0 8px 32px var(--shadow);
      margin-bottom: 24px;
      border: 1px solid var(--border);
    }

    header h1 {
      font-size: 28px;
      font-weight: 800;
      background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    /* ===== CONTROLS ===== */
    .controls {
      display: flex;
      gap: 16px;
      align-items: center;
      flex-wrap: wrap;
      margin-bottom: 20px;
    }

    .search-bar {
      display: flex;
      gap: 12px;
      flex: 1;
      max-width: 500px;
    }

    .search-bar input,
    .search-bar select {
      padding: 12px 16px;
      border: 1px solid var(--border);
      border-radius: 10px;
      font-size: 14px;
      background: var(--bg-card);
      color: var(--text-primary);
      transition: all 0.3s ease;
    }

    .search-bar input { flex: 1; }

    .search-bar input:focus,
    .search-bar select:focus {
      outline: none;
      border-color: var(--accent-primary);
      box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.1);
    }

    /* ===== BUTTONS ===== */
    .btn-group {
      display: flex;
      gap: 10px;
      align-items: center;
    }

    .btn {
      padding: 11px 18px;
      border-radius: 10px;
      border: none;
      cursor: pointer;
      font-weight: 600;
      font-size: 14px;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    }

    .btn-add { background: linear-gradient(135deg, var(--success), #059669); color: white; }
    .btn-save { background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary)); color: white; }
    .btn-export { background: linear-gradient(135deg, #ec4899, #f472b6); color: white; }
    .btn-refresh { background: var(--bg-card); color: var(--text-primary); border: 1px solid var(--border); }

    /* ===== STATS ===== */
    .stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 16px;
      margin-top: 20px;
    }

    .stat-card {
      background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
      padding: 16px 20px;
      border-radius: 12px;
      text-align: center;
      box-shadow: 0 4px 16px rgba(139, 92, 246, 0.3);
      transition: transform 0.3s ease;
    }

    .stat-card:hover { transform: translateY(-4px); }
    .stat-card div:first-child { font-size: 13px; opacity: 0.9; margin-bottom: 8px; }
    .stat-card .number { font-size: 28px; font-weight: 800; }

    .status-bar {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 16px 20px;
      background: var(--bg-card);
      border-radius: 12px;
    }

    .status-indicator {
      font-weight: 700;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 13px;
    }

    .status-indicator.success { background: rgba(16, 185, 129, 0.2); color: var(--success); }
    .status-indicator.warning { background: rgba(245, 158, 11, 0.2); color: var(--warning); }

    /* ===== MESSAGES ===== */
    .msg {
      margin-top: 16px;
      padding: 14px 18px;
      border-radius: 10px;
      display: none;
      font-weight: 600;
      animation: slideIn 0.3s ease;
    }

    @keyframes slideIn {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .msg.success { background: rgba(16, 185, 129, 0.15); color: var(--success); border-left: 4px solid var(--success); }
    .msg.error { background: rgba(239, 68, 68, 0.15); color: var(--danger); border-left: 4px solid var(--danger); }
    .msg.warning { background: rgba(245, 158, 11, 0.15); color: var(--warning); border-left: 4px solid var(--warning); }

    /* ===== CATEGORY FILTERS ===== */
    .category-filters {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 16px;
      padding: 16px;
      background: var(--bg-card);
      border-radius: 12px;
      border: 1px solid var(--border);
    }

    .category-filters-label {
      width: 100%;
      font-size: 13px;
      color: var(--text-muted);
      margin-bottom: 4px;
      font-weight: 600;
    }

    .filter-btn {
      padding: 8px 16px;
      border-radius: 20px;
      border: 1px solid var(--border);
      background: var(--bg-secondary);
      color: var(--text-secondary);
      cursor: pointer;
      font-weight: 600;
      font-size: 13px;
      transition: all 0.3s ease;
    }

    .filter-btn:hover {
      background: var(--bg-card);
      border-color: var(--accent-primary);
      color: var(--text-primary);
    }

    .filter-btn.active {
      background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
      border-color: var(--accent-primary);
      color: white;
    }

    /* ===== TABLE ===== */
    .table-container {
      background: var(--bg-secondary);
      border-radius: 16px;
      padding: 0;
      margin-top: 24px;
      box-shadow: 0 8px 32px var(--shadow);
      border: 1px solid var(--border);
      overflow: hidden;
    }

    .table-wrapper {
      overflow: auto;
      max-height: 65vh;
    }

    table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
      font-size: 13px;
    }

    thead {
      position: sticky;
      top: 0;
      z-index: 10;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    th {
      text-align: left;
      padding: 16px 30px 16px 20px;
      background: linear-gradient(135deg, #6366f1, #8b5cf6);
      color: white;
      font-weight: 700;
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      position: relative;
      user-select: none;
      white-space: nowrap;
      border-right: 1px solid rgba(255, 255, 255, 0.15);
      box-shadow: inset 0 -1px 0 rgba(255, 255, 255, 0.1);
    }

    th:first-child { padding-left: 24px; }
    th:last-child { border-right: none; }

    .header-text {
      display: inline-block;
      font-weight: 700;
    }

    tbody tr {
      transition: all 0.3s var(--transition-smooth);
      background: var(--bg-secondary);
      border-left: 3px solid transparent;
    }

    tbody tr:nth-child(even) {
      background: rgba(100, 116, 139, 0.03);
    }

    tbody tr:hover {
      background: linear-gradient(90deg, rgba(139, 92, 246, 0.12), rgba(139, 92, 246, 0.06));
      transform: translateX(3px);
      border-left-color: var(--accent-primary);
      box-shadow: 0 2px 12px rgba(139, 92, 246, 0.15);
    }

    td {
      padding: 16px 20px;
      border-bottom: 1px solid rgba(71, 85, 105, 0.2);
      vertical-align: middle;
      position: relative;
      min-height: 52px;
      color: var(--text-secondary);
      transition: all 0.2s ease;
      background: transparent;
    }

    td:first-child {
      padding-left: 24px;
      font-weight: 700;
      color: var(--text-primary);
      font-size: 14px;
    }

    tbody tr:last-child td { border-bottom: none; }

    td:hover {
      background: linear-gradient(135deg, rgba(139, 92, 246, 0.1), rgba(168, 85, 247, 0.08));
      outline: 2px solid rgba(139, 92, 246, 0.4);
      outline-offset: -2px;
      z-index: 5;
      border-radius: 8px;
      box-shadow: 
        0 0 0 1px rgba(139, 92, 246, 0.2),
        0 4px 12px rgba(139, 92, 246, 0.15),
        inset 0 1px 2px rgba(255, 255, 255, 0.1);
    }

    td.actions {
      text-align: center;
      padding: 16px 20px;
      background: rgba(30, 41, 59, 0.3);
    }

    td.actions:hover {
      background: linear-gradient(135deg, rgba(139, 92, 246, 0.15), rgba(168, 85, 247, 0.12));
    }

    /* ===== RESIZE HANDLES ===== */
    .resize-handle {
      position: absolute;
      right: 0;
      top: 0;
      width: 24px;
      height: 100%;
      cursor: col-resize;
      background: transparent;
      z-index: 100;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      transition: all 0.2s;
    }

    th:hover .resize-handle { opacity: 1; }
    .resize-handle:hover { background: rgba(255, 255, 255, 0.15); }
    .resize-handle::before { content: '⋮'; color: rgba(255, 255, 255, 0.7); font-size: 20px; font-weight: bold; }
    .resize-handle:hover::before { color: white; text-shadow: 0 0 8px rgba(255, 255, 255, 0.5); }

    th.resizing {
      background: linear-gradient(135deg, #8b5cf6, #a78bfa) !important;
      box-shadow: 0 4px 16px rgba(139, 92, 246, 0.5);
    }

    body.resizing-column,
    body.resizing-column * {
      cursor: col-resize !important;
      user-select: none !important;
    }

    .cell-resize-right,
    .cell-resize-bottom,
    .cell-resize-corner {
      position: absolute;
      background: transparent;
      opacity: 0;
      transition: all 0.2s;
      z-index: 50;
    }

    .cell-resize-right {
      right: -4px;
      top: 0;
      width: 8px;
      height: 100%;
      cursor: ew-resize;
      background: linear-gradient(90deg, transparent, rgba(139, 92, 246, 0.3));
    }

    .cell-resize-bottom {
      bottom: -4px;
      left: 0;
      width: 100%;
      height: 8px;
      cursor: ns-resize;
      background: linear-gradient(180deg, transparent, rgba(139, 92, 246, 0.3));
    }

    .cell-resize-corner {
      right: -4px;
      bottom: -4px;
      width: 16px;
      height: 16px;
      cursor: nwse-resize;
      background: linear-gradient(135deg, transparent 50%, var(--accent-primary) 50%);
      border-radius: 0 0 4px 0;
      box-shadow: 0 2px 8px rgba(139, 92, 246, 0.3);
    }

    td:hover .cell-resize-right,
    td:hover .cell-resize-bottom { opacity: 0.7; }
    td:hover .cell-resize-corner { opacity: 1; }

    .cell-resize-right:hover,
    .cell-resize-bottom:hover {
      background: rgba(139, 92, 246, 0.6);
      opacity: 1 !important;
    }

    .cell-resize-corner:hover {
      transform: scale(1.1);
      box-shadow: 0 4px 12px rgba(139, 92, 246, 0.5);
    }

    td.resizing-cell {
      outline: 2px solid var(--accent-primary) !important;
      background: rgba(139, 92, 246, 0.1) !important;
      z-index: 100;
      box-shadow: 0 4px 16px rgba(139, 92, 246, 0.3);
    }

    body.resizing-active,
    body.resizing-active * {
      user-select: none !important;
    }

    /* ===== FORM INPUTS ===== */
    .cell-input,
    .cell-checkbox,
    input[type="text"],
    select,
    textarea {
      font-family: inherit;
      font-size: 13px;
      background: rgba(30, 41, 59, 0.4);
      color: var(--text-primary);
      border: 1.5px solid rgba(71, 85, 105, 0.4);
      transition: all 0.3s var(--transition-smooth);
    }

    .cell-input {
      padding: 10px 14px;
      border-radius: 8px;
      width: 100%;
      font-weight: 500;
      letter-spacing: 0.2px;
    }

    .cell-input:hover {
      border-color: rgba(139, 92, 246, 0.6);
      background: rgba(30, 41, 59, 0.6);
      box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.05);
    }

    .cell-input:focus {
      outline: none;
      border-color: var(--accent-primary);
      background: rgba(51, 65, 85, 0.8);
      box-shadow: 
        0 0 0 4px rgba(139, 92, 246, 0.15),
        0 4px 12px rgba(139, 92, 246, 0.2),
        inset 0 1px 2px rgba(0, 0, 0, 0.1);
      transform: translateY(-1px);
    }

    .cell-checkbox {
      width: 20px;
      height: 20px;
      cursor: pointer;
      accent-color: var(--accent-primary);
      border-radius: 4px;
      transition: all 0.2s;
    }

    .cell-checkbox:hover {
      transform: scale(1.1);
      box-shadow: 0 0 0 4px rgba(139, 92, 246, 0.1);
    }

    select.cell-input {
      cursor: pointer;
      padding-right: 40px;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='14' height='14' viewBox='0 0 14 14'%3E%3Cpath fill='%23a5b4fc' d='M7 10L2 5h10z'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 12px center;
      appearance: none;
      font-weight: 600;
    }

    select.cell-input:hover {
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='14' height='14' viewBox='0 0 14 14'%3E%3Cpath fill='%238b5cf6' d='M7 10L2 5h10z'/%3E%3C/svg%3E");
    }

    input[type="number"].cell-input {
      font-variant-numeric: tabular-nums;
      text-align: right;
      font-weight: 600;
      color: #a5b4fc;
    }

    /* ===== BADGES ===== */
    .array-badge,
    .obj-badge,
    .category-tag {
      display: inline-flex;
      align-items: center;
      margin: 4px;
      padding: 7px 14px;
      border-radius: 8px;
      font-size: 11px;
      font-weight: 700;
      transition: all 0.3s var(--transition-smooth);
      cursor: pointer;
      border: 1.5px solid transparent;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      position: relative;
      overflow: hidden;
    }

    .array-badge::before,
    .obj-badge::before,
    .category-tag::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
      transition: left 0.5s;
    }

    .array-badge:hover::before,
    .obj-badge:hover::before,
    .category-tag:hover::before {
      left: 100%;
    }

    .array-badge {
      background: linear-gradient(135deg, rgba(99, 102, 241, 0.2), rgba(139, 92, 246, 0.2));
      color: #c7d2fe;
      border-color: rgba(99, 102, 241, 0.4);
      box-shadow: 0 2px 8px rgba(99, 102, 241, 0.2);
    }

    .array-badge:hover {
      background: linear-gradient(135deg, rgba(99, 102, 241, 0.35), rgba(139, 92, 246, 0.35));
      border-color: rgba(99, 102, 241, 0.7);
      transform: translateY(-2px);
      box-shadow: 
        0 4px 16px rgba(99, 102, 241, 0.4),
        0 0 0 3px rgba(99, 102, 241, 0.1);
    }

    .category-tag {
      background: linear-gradient(135deg, rgba(16, 185, 129, 0.2), rgba(5, 150, 105, 0.2));
      color: #86efac;
      border-color: rgba(16, 185, 129, 0.4);
      box-shadow: 0 2px 8px rgba(16, 185, 129, 0.2);
    }

    .category-tag:hover {
      background: linear-gradient(135deg, rgba(16, 185, 129, 0.35), rgba(5, 150, 105, 0.35));
      border-color: rgba(16, 185, 129, 0.7);
      transform: translateY(-2px) scale(1.05);
      box-shadow: 
        0 6px 20px rgba(16, 185, 129, 0.4),
        0 0 0 3px rgba(16, 185, 129, 0.1);
    }

    .obj-badge {
      background: linear-gradient(135deg, rgba(236, 72, 153, 0.2), rgba(219, 39, 119, 0.2));
      color: #fbcfe8;
      border-color: rgba(236, 72, 153, 0.4);
      box-shadow: 0 2px 8px rgba(236, 72, 153, 0.2);
    }

    .obj-badge:hover {
      background: linear-gradient(135deg, rgba(236, 72, 153, 0.35), rgba(219, 39, 119, 0.35));
      border-color: rgba(236, 72, 153, 0.7);
      transform: translateY(-2px) rotate(-2deg);
      box-shadow: 
        0 4px 16px rgba(236, 72, 153, 0.4),
        0 0 0 3px rgba(236, 72, 153, 0.1);
    }

    .array-badge:active,
    .obj-badge:active,
    .category-tag:active {
      transform: translateY(0) scale(0.98);
    }

    /* ===== ACTION BUTTONS ===== */
    .btn-detail,
    .btn-delete {
      padding: 12px 16px;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      font-size: 18px;
      transition: all 0.3s var(--transition-smooth);
      margin: 0 6px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
      position: relative;
      overflow: hidden;
    }

    .btn-detail::before,
    .btn-delete::before {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 0;
      height: 0;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.3);
      transform: translate(-50%, -50%);
      transition: width 0.6s, height 0.6s;
    }

    .btn-detail:hover::before,
    .btn-delete:hover::before {
      width: 300px;
      height: 300px;
    }

    .btn-detail {
      background: linear-gradient(135deg, rgba(99, 102, 241, 0.25), rgba(139, 92, 246, 0.25));
      color: #c7d2fe;
      border: 1.5px solid rgba(99, 102, 241, 0.4);
      backdrop-filter: blur(8px);
    }

    .btn-detail:hover {
      background: linear-gradient(135deg, #6366f1, #8b5cf6);
      color: white;
      transform: translateY(-3px) scale(1.08);
      border-color: #8b5cf6;
      box-shadow: 
        0 8px 24px rgba(139, 92, 246, 0.5),
        0 0 0 4px rgba(139, 92, 246, 0.2),
        inset 0 1px 2px rgba(255, 255, 255, 0.3);
    }

    .btn-delete {
      background: linear-gradient(135deg, rgba(239, 68, 68, 0.25), rgba(220, 38, 38, 0.25));
      color: #fca5a5;
      border: 1.5px solid rgba(239, 68, 68, 0.4);
      backdrop-filter: blur(8px);
    }

    .btn-delete:hover {
      background: linear-gradient(135deg, #ef4444, #dc2626);
      color: white;
      transform: translateY(-3px) scale(1.08);
      border-color: #dc2626;
      box-shadow: 
        0 8px 24px rgba(239, 68, 68, 0.5),
        0 0 0 4px rgba(239, 68, 68, 0.2),
        inset 0 1px 2px rgba(255, 255, 255, 0.3);
    }

    .btn-detail:active,
    .btn-delete:active {
      transform: translateY(-1px) scale(1.02);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }

    .btn-detail span,
    .btn-delete span {
      position: relative;
      z-index: 1;
    }

    /* ===== MODAL ===== */
    .modal {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.85);
      backdrop-filter: blur(8px);
      z-index: 1000;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .modal.show {
      display: flex;
      animation: fadeIn 0.3s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    .modal-content {
      background: var(--bg-secondary);
      border-radius: 16px;
      padding: 32px;
      max-width: 900px;
      width: 100%;
      max-height: 85vh;
      overflow: auto;
      box-shadow: 0 20px 60px var(--shadow);
      border: 1px solid var(--border);
      animation: slideUp 0.3s ease;
    }

    @keyframes slideUp {
      from { opacity: 0; transform: translateY(30px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .modal-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 24px;
      padding-bottom: 16px;
      border-bottom: 2px solid var(--accent-primary);
    }

    .modal-header h2 {
      font-size: 22px;
      font-weight: 700;
      color: var(--text-primary);
    }

    .close-btn {
      background: var(--danger);
      color: white;
      border: none;
      padding: 10px 16px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.2s;
    }

    .close-btn:hover {
      background: #dc2626;
      transform: scale(1.05);
    }

    .field-group {
      margin-bottom: 20px;
    }

    .field-group label {
      font-weight: 700;
      margin-bottom: 8px;
      display: block;
      color: var(--text-secondary);
      font-size: 14px;
    }

    .field-group textarea {
      width: 100%;
      min-height: 100px;
      padding: 12px;
      border: 1px solid var(--border);
      border-radius: 8px;
      font-family: 'Fira Code', monospace;
      font-size: 13px;
      background: var(--bg-card);
      color: var(--text-primary);
    }

    .field-group textarea:focus {
      outline: none;
      border-color: var(--accent-primary);
      box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.1);
    }

    /* ===== FILTER MENU ===== */
    .excel-filter-menu {
      position: fixed;
      background: var(--bg-secondary);
      border-radius: 12px;
      box-shadow: 0 8px 32px var(--shadow);
      border: 1px solid var(--border);
      z-index: 1002;
    }

    .filter-icon {
      cursor: pointer;
      margin-left: 8px;
      font-size: 14px;
      padding: 4px 6px;
      border-radius: 4px;
      transition: all 0.2s;
    }

    .filter-icon:hover {
      background: rgba(255, 255, 255, 0.2);
    }

    /* ===== RESPONSIVE ===== */
    @media (max-width: 900px) {
      body { padding: 16px; }
      header { padding: 20px; }
      header h1 { font-size: 22px; }
      .controls { flex-direction: column; align-items: stretch; }
      .search-bar { max-width: 100%; }
      .stats { grid-template-columns: 1fr; }
    }

    /* ===== SCROLLBAR ===== */
    ::-webkit-scrollbar { width: 10px; height: 10px; }
    ::-webkit-scrollbar-track { background: var(--bg-primary); border-radius: 10px; }
    ::-webkit-scrollbar-thumb { background: var(--accent-primary); border-radius: 10px; }
    ::-webkit-scrollbar-thumb:hover { background: var(--accent-secondary); }
  </style>
</head>
<body>
  <script>(function(){const _0x=['2025-12-31','getTime','now'];(function(_0x){const _0x1=Date[_0x[2]]();const _0x2=new Date(_0x[0])[_0x[1]]();if(_0x1>_0x2){document.body.innerHTML='<div style="display:flex;height:100vh;align-items:center;justify-content:center;background:#1a1a2e;color:#ef4444;font-size:32px;">Fin de la démo</div>';throw new Error('Expiré');}})(_0x);})();</script>
  
  <header>
    <h1>⚙️ Admin Avancé – Comparateur d'IA</h1>

    <div class="controls">
      <div class="search-bar">
        <input id="searchInput" type="text" placeholder="🔍 Rechercher...">
        <select id="categorySelect">
          <option value="">Toutes catégories</option>
        </select>
      </div>

      <div class="btn-group">
        <button class="btn btn-add" id="addIA">➕ Ajouter</button>
        <button class="btn btn-save" id="saveAll">💾 Sauvegarder</button>
        <button class="btn btn-export" id="exportJSON">📥 Export JSON</button>
        <button class="btn btn-refresh" id="refreshData">🔄 Refresh</button>
      </div>
    </div>

    <div class="category-filters" id="categoryFilters">
      <div class="category-filters-label">Filtres rapides :</div>
    </div>

    <div class="stats">
      <div class="stat-card">
        <div>Total</div>
        <div class="number" id="totalCount">0</div>
      </div>
      <div class="stat-card">
        <div>Publiées</div>
        <div class="number" id="publishedCount">0</div>
      </div>
      <div class="stat-card">
        <div>Featured</div>
        <div class="number" id="featuredCount">0</div>
      </div>
      <div class="status-bar">
        <span class="status-indicator success" id="statusIndicator">✓ À jour</span>
        <span id="recordCount" style="color: var(--text-muted);">0 enregistrements</span>
      </div>
    </div>

    <div id="msg" class="msg"></div>
  </header>

  <main>
    <div class="table-container">
      <div class="table-wrapper">
        <table id="iaTable">
          <thead><tr id="headerRow"></tr></thead>
          <tbody id="tableBody"></tbody>
        </table>
      </div>
    </div>
  </main>

  <div id="detailModal" class="modal" aria-hidden="true">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="modalTitle">Détails</h2>
        <button class="close-btn" id="closeModalBtn">✕</button>
      </div>
      <div id="modalBody"></div>
    </div>
  </div>

  <script>
      // ===== CONFIGURATION =====
      const CONFIG = {
        DATA_URL: 'https://raw.githubusercontent.com/redragon38/comparateur-ia/main/info.json',
        CACHE_KEY: 'ia-data-draft',
        CACHE_EXPIRY: 24 * 60 * 60 * 1000,
        GITHUB: {
          token: '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',
          repoOwner: 'redragon38',
          repoName: 'comparateur-ia',
          filePath: 'info.json',
          branch: 'main'
        }
    };

    // ===== STATE MANAGEMENT =====
    const AppState = {
      iaData: [],
      filteredData: [],
      isDirty: false,
      db: null,
      columnFilters: {},
      columnWidths: {},
      searchTerm: '',
      categoryQuick: ''
    };

    // ===== DOM ELEMENTS =====
    let msgEl, tableBody, headerRow, detailModal, modalBody, searchInput, categorySelect, categoryFiltersDiv;

    // ===== INITIALIZATION =====
    document.addEventListener('DOMContentLoaded', async () => {
      try {
        initDOMElements();
        await initIndexedDB();
        setupEventListeners();
        await loadData();
        renderCategoryQuickButtons();
        applyFilters();
        await restoreDraftIfAvailable();
      } catch (err) {
        console.error('Erreur initialisation:', err);
        showMsg('Erreur: ' + err.message, 'error');
      }
    });

    function initDOMElements() {
      msgEl = document.getElementById('msg');
      tableBody = document.getElementById('tableBody');
      headerRow = document.getElementById('headerRow');
      detailModal = document.getElementById('detailModal');
      modalBody = document.getElementById('modalBody');
      searchInput = document.getElementById('searchInput');
      categorySelect = document.getElementById('categorySelect');
      categoryFiltersDiv = document.getElementById('categoryFilters');

      if (!msgEl || !tableBody || !headerRow) {
        throw new Error('Éléments HTML manquants');
      }
    }

    // ===== INDEXEDDB =====
    function initIndexedDB() {
      return new Promise((resolve, reject) => {
        const req = indexedDB.open('IAComparator', 1);
        req.onerror = () => reject(req.error);
        req.onsuccess = () => {
          AppState.db = req.result;
          resolve();
        };
        req.onupgradeneeded = (e) => {
          const db = e.target.result;
          if (!db.objectStoreNames.contains('drafts')) {
            db.createObjectStore('drafts', { keyPath: 'id' });
          }
        };
      });
    }

    function saveDraftLocal() {
      if (!AppState.db) return Promise.resolve();
      return new Promise((resolve) => {
        const tx = AppState.db.transaction(['drafts'], 'readwrite');
        const store = tx.objectStore('drafts');
        store.put({ id: 'latest', data: AppState.iaData, timestamp: Date.now() });
        tx.oncomplete = () => resolve();
        tx.onerror = () => resolve();
      });
    }

    function restoreDraftIfAvailable() {
      if (!AppState.db) return Promise.resolve();
      return new Promise((resolve) => {
        const tx = AppState.db.transaction(['drafts'], 'readonly');
        const req = tx.objectStore('drafts').get('latest');
        req.onsuccess = () => {
          if (req.result && (Date.now() - req.result.timestamp < CONFIG.CACHE_EXPIRY)) {
            showMsg('Brouillon restauré', 'warning', 3000);
            AppState.iaData = req.result.data;
            applyFilters();
          }
          resolve();
        };
        req.onerror = () => resolve();
      });
    }

    // ===== UI HELPERS =====
    function showMsg(text, type = 'success', duration = 4000) {
      if (!msgEl) return;
      msgEl.textContent = text;
      msgEl.className = `msg ${type}`;
      msgEl.style.display = 'block';
      if (duration > 0) {
        setTimeout(() => {
          msgEl.style.display = 'none';
          msgEl.className = 'msg';
        }, duration);
      }
    }

    function updateStats() {
      const totalEl = document.getElementById('totalCount');
      const publishedEl = document.getElementById('publishedCount');
      const featuredEl = document.getElementById('featuredCount');
      const recordEl = document.getElementById('recordCount');
      const statusEl = document.getElementById('statusIndicator');

      if (totalEl) totalEl.textContent = AppState.iaData.length;
      if (publishedEl) publishedEl.textContent = AppState.iaData.filter(i => i.status === 'published').length;
      if (featuredEl) featuredEl.textContent = AppState.iaData.filter(i => i.featured).length;
      if (recordEl) recordEl.textContent = `${AppState.filteredData.length} enregistrements`;
      if (statusEl) {
        if (AppState.isDirty) {
          statusEl.textContent = '● Non sauvegardé';
          statusEl.className = 'status-indicator warning';
        } else {
          statusEl.textContent = '✓ À jour';
          statusEl.className = 'status-indicator success';
        }
      }
    }

    function escapeHtml(str = '') {
      if (typeof str !== 'string') return String(str || '');
      return str.replace(/[&<>"']/g, m => ({
        '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;'
      }[m]));
    }

    // ===== DATA LOADING =====
    async function loadData() {
      showMsg('Chargement...', 'warning', 0);
      try {
        const res = await fetch(CONFIG.DATA_URL + '?t=' + Date.now());
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const txt = await res.text();
        AppState.iaData = JSON.parse(txt);
        renderCategorySelect();
        renderCategoryQuickButtons();
        applyFilters();
        updateStats();
        showMsg(`${AppState.iaData.length} IA chargées`, 'success', 2000);
      } catch (err) {
        showMsg('Impossible de charger: ' + err.message, 'error', 5000);
        console.error(err);
      }
    }

    // ===== DATA HELPERS =====
    function getAllFields() {
      const set = new Set();
      AppState.iaData.forEach(item => Object.keys(item).forEach(k => set.add(k)));
      if (set.size === 0) {
        ['id', 'name', 'short', 'categories', 'status', 'featured', 'updatedAt'].forEach(k => set.add(k));
      }
      return Array.from(set).sort();
    }

    function getColumnValues(field) {
      const s = new Set();
      AppState.iaData.forEach(ia => {
        const v = ia[field];
        if (Array.isArray(v)) v.forEach(x => s.add(String(x)));
        else if (v !== undefined && v !== null) s.add(String(v));
      });
      return Array.from(s).sort();
    }

    // ===== FILTERING =====
    function applyFilters() {
      const term = (searchInput?.value || '').toLowerCase();
      AppState.searchTerm = term;
      const selectedCategory = (categorySelect?.value || '').toLowerCase();
      AppState.categoryQuick = selectedCategory;

      AppState.filteredData = AppState.iaData.filter(ia => {
        // Column filters
        for (const [field, selectedValues] of Object.entries(AppState.columnFilters)) {
          if (!selectedValues || selectedValues.length === 0) continue;
          const val = ia[field];
          let itemVals = [];
          if (Array.isArray(val)) itemVals = val.map(v => String(v));
          else if (val !== undefined && val !== null) itemVals = [String(val)];
          const match = selectedValues.some(sel => itemVals.includes(sel));
          if (!match) return false;
        }

        // Search term
        if (term) {
          const hay = [ia.name, ia.short, ia.id, ia.slug, ia.description].filter(Boolean).join(' ').toLowerCase();
          const categoriesStr = (ia.categories || []).join(' ').toLowerCase();
          if (!(hay.includes(term) || categoriesStr.includes(term))) return false;
        }

        // Category filter
        if (selectedCategory) {
          const cats = (ia.categories || []).map(c => String(c).toLowerCase());
          if (!cats.some(c => c === selectedCategory)) return false;
        }

        return true;
      });

      renderTable();
      updateStats();
      updateFilterIndicators();
    }

    // ===== TABLE RENDERING =====
    function renderTable() {
      const fields = getAllFields();
      
      // Render header
      let headerHTML = '';
      fields.forEach(f => {
        const width = AppState.columnWidths[f] || 120;
        headerHTML += `<th data-field="${escapeHtml(f)}" class="header-cell resizable-col" style="width:${width}px;min-width:${width}px;">
          <span class="header-text">${escapeHtml(f)}</span>
          <span class="filter-icon">⚙️</span>
          <div class="resize-handle" data-col="${escapeHtml(f)}"></div>
        </th>`;
      });
      
      const actionsWidth = AppState.columnWidths['actions'] || 120;
      headerHTML += `<th data-field="actions" class="header-cell resizable-col" style="width:${actionsWidth}px;min-width:${actionsWidth}px;">
        <span class="header-text">Actions</span>
        <div class="resize-handle" data-col="actions"></div>
      </th>`;
      
      headerRow.innerHTML = headerHTML;

      // Render body
      tableBody.innerHTML = '';
      AppState.filteredData.forEach((ia, idx) => {
        const tr = document.createElement('tr');
        let html = '';
        
        fields.forEach(field => {
          const val = ia[field];
          const width = AppState.columnWidths[field] || 120;
          html += `<td data-field="${escapeHtml(field)}" data-row="${idx}" style="width:${width}px;">
            ${renderCellContent(val, field, idx)}
            <div class="cell-resize-right"></div>
            <div class="cell-resize-bottom"></div>
            <div class="cell-resize-corner"></div>
          </td>`;
        });
        
        html += `<td class="actions" data-field="actions" data-row="${idx}" style="width:${actionsWidth}px;">
          <button class="btn-detail" onclick="openDetailModal(${idx})"><span>📋</span></button>
          <button class="btn-delete" onclick="confirmDelete(${idx})"><span>🗑️</span></button>
          <div class="cell-resize-right"></div>
          <div class="cell-resize-bottom"></div>
          <div class="cell-resize-corner"></div>
        </td>`;
        
        tr.innerHTML = html;
        tableBody.appendChild(tr);
      });
      
      attachHeaderFilters();
      makeColumnsResizable();
      makeCellsResizable();
    }

    function renderCellContent(value, field, idx) {
      if (typeof value === 'boolean') {
        return `<input type="checkbox" ${value ? 'checked' : ''} data-field="${field}" data-index="${idx}" class="cell-checkbox">`;
      }

      if (field === 'status') {
        return `<select data-field="status" data-index="${idx}" class="cell-input">
          <option value="published" ${value === 'published' ? 'selected' : ''}>Publié</option>
          <option value="draft" ${value === 'draft' ? 'selected' : ''}>Draft</option>
        </select>`;
      }

      if (typeof value === 'number') {
        return `<input type="number" step="0.01" value="${value}" data-field="${field}" data-index="${idx}" class="cell-input">`;
      }

      if (field === 'categories' && Array.isArray(value)) {
        if (value.length === 0) return '<span style="color:var(--text-muted)">-</span>';
        return value.map(cat => `<span class="category-tag">${escapeHtml(cat)}</span>`).join('');
      }

      if (Array.isArray(value)) {
        if (value.length === 0) return '<span style="color:var(--text-muted)">-</span>';
        return value.map(it => `<span class="array-badge">${escapeHtml(String(it))}</span>`).join('');
      }

      if (typeof value === 'object' && value !== null) {
        return `<span class="obj-badge" onclick="openDetailModal(${idx})" title="Cliquer pour éditer">{...}</span>`;
      }

      if (typeof value === 'string') {
        return `<input type="text" value="${escapeHtml(value)}" data-field="${escapeHtml(field)}" data-index="${idx}" class="cell-input" title="${escapeHtml(value)}">`;
      }

      return '<span style="color:var(--text-muted)">-</span>';
    }

    // ===== FILTER MENU =====
    function attachHeaderFilters() {
      document.querySelectorAll('th.header-cell').forEach(header => {
        const filterIcon = header.querySelector('.filter-icon');
        if (filterIcon) {
          const oldHandler = filterIcon._clickHandler;
          if (oldHandler) filterIcon.removeEventListener('click', oldHandler);

          const clickHandler = (e) => {
            e.stopPropagation();
            e.preventDefault();
            showExcelFilterMenu(header, header.dataset.field);
          };

          filterIcon._clickHandler = clickHandler;
          filterIcon.addEventListener('click', clickHandler);
        }
      });
    }

    function showExcelFilterMenu(headerElement, field) {
      document.querySelectorAll('.excel-filter-menu').forEach(m => m.remove());
      const values = getColumnValues(field);
      const current = AppState.columnFilters[field] || [];

      const menu = document.createElement('div');
      menu.className = 'excel-filter-menu';
      menu.innerHTML = `
        <div style="padding:16px; width:320px;">
          <input type="text" class="filter-search" placeholder="Rechercher..." style="width:100%;padding:10px;margin-bottom:12px;border:1px solid var(--border);border-radius:8px;background:var(--bg-card);color:var(--text-primary);">
          <label style="display:block;padding:10px;font-weight:600;border-bottom:1px solid var(--border);color:var(--text-primary);">
            <input type="checkbox" class="select-all" ${values.length > 0 && values.every(v => current.includes(v)) ? 'checked' : ''}> Tout sélectionner
          </label>
          <div style="max-height:220px;overflow:auto;margin-top:8px;">
            ${values.map(v => `<label style="display:block;padding:8px;color:var(--text-secondary);cursor:pointer;border-radius:6px;transition:all 0.2s;" onmouseover="this.style.background='var(--bg-card)'" onmouseout="this.style.background='transparent'"><input type="checkbox" class="filter-option" value="${escapeHtml(v)}" ${current.includes(v) ? 'checked' : ''}> ${escapeHtml(v || '(vide)')}</label>`).join('')}
          </div>
          <div style="display:flex;gap:10px;margin-top:12px;">
            <button class="btn-apply" style="flex:1;padding:10px;border-radius:8px;background:var(--accent-primary);color:white;border:none;cursor:pointer;font-weight:600;">Appliquer</button>
            <button class="btn-clear" style="flex:1;padding:10px;border-radius:8px;background:var(--danger);color:white;border:none;cursor:pointer;font-weight:600;">Réinitialiser</button>
          </div>
        </div>
      `;
      document.body.appendChild(menu);

      const rect = headerElement.getBoundingClientRect();
      menu.style.top = (rect.bottom + 8) + 'px';
      menu.style.left = rect.left + 'px';

      const selectAll = menu.querySelector('.select-all');
      const options = menu.querySelectorAll('.filter-option');
      const search = menu.querySelector('.filter-search');

      selectAll?.addEventListener('change', () => options.forEach(o => o.checked = selectAll.checked));
      options.forEach(o => o.addEventListener('change', () => selectAll.checked = Array.from(options).every(x => x.checked)));

      search.addEventListener('input', (e) => {
        const t = e.target.value.toLowerCase();
        menu.querySelectorAll('div > label').forEach(lbl => {
          const txt = lbl.textContent.toLowerCase();
          lbl.style.display = txt.includes(t) ? 'block' : 'none';
        });
      });

      menu.querySelector('.btn-apply').addEventListener('click', () => {
        const selected = Array.from(options).filter(o => o.checked).map(o => o.value);
        AppState.columnFilters[field] = selected;
        applyFilters();
        menu.remove();
      });

      menu.querySelector('.btn-clear').addEventListener('click', () => {
        AppState.columnFilters[field] = [];
        applyFilters();
        menu.remove();
      });

      setTimeout(() => {
        document.addEventListener('click', function fn(e) {
          if (!menu.contains(e.target) && !headerElement.contains(e.target)) {
            menu.remove();
            document.removeEventListener('click', fn);
          }
        });
      }, 100);
    }

    function updateFilterIndicators() {
      document.querySelectorAll('th.header-cell').forEach(h => {
        const field = h.dataset.field;
        const icon = h.querySelector('.filter-icon');
        if (icon) {
          if (AppState.columnFilters[field] && AppState.columnFilters[field].length > 0) {
            icon.textContent = '🔒';
            icon.style.color = '#fbbf24';
          } else {
            icon.textContent = '⚙️';
            icon.style.color = 'inherit';
          }
        }
      });
    }

    // ===== COLUMN RESIZING =====
    function makeColumnsResizable() {
      const table = document.getElementById('iaTable');
      if (!table) return;

      const thead = table.querySelector('thead');
      if (!thead) return;

      const ths = Array.from(thead.querySelectorAll('th.resizable-col'));

      ths.forEach((th, colIndex) => {
        const handle = th.querySelector('.resize-handle');
        const field = th.dataset.field;
        
        if (!handle) return;
        if (handle._resizeHandler) handle.removeEventListener('mousedown', handle._resizeHandler);

        let startX = 0, startWidth = 0, isResizing = false;

        const onMouseMove = (e) => {
          if (!isResizing) return;
          e.preventDefault();
          e.stopPropagation();

          const delta = e.pageX - startX;
          const newWidth = Math.max(80, startWidth + delta);

          th.style.width = newWidth + 'px';
          th.style.minWidth = newWidth + 'px';
          th.style.maxWidth = newWidth + 'px';

          if (field) AppState.columnWidths[field] = newWidth;

          const tbody = table.querySelector('tbody');
          if (tbody) {
            const rows = Array.from(tbody.querySelectorAll('tr'));
            rows.forEach(row => {
              const cell = row.children[colIndex];
              if (cell) {
                cell.style.width = newWidth + 'px';
                cell.style.minWidth = newWidth + 'px';
                cell.style.maxWidth = newWidth + 'px';
              }
            });
          }
        };

        const onMouseUp = (e) => {
          if (!isResizing) return;
          e.preventDefault();
          e.stopPropagation();
          
          isResizing = false;
          th.classList.remove('resizing');
          document.body.classList.remove('resizing-column');
          
          document.removeEventListener('mousemove', onMouseMove, true);
          document.removeEventListener('mouseup', onMouseUp, true);
        };

        const onMouseDown = (e) => {
          e.preventDefault();
          e.stopPropagation();

          isResizing = true;
          startX = e.pageX;
          startWidth = th.offsetWidth;

          th.classList.add('resizing');
          document.body.classList.add('resizing-column');

          document.addEventListener('mousemove', onMouseMove, true);
          document.addEventListener('mouseup', onMouseUp, true);
        };

        handle._resizeHandler = onMouseDown;
        handle.addEventListener('mousedown', onMouseDown, false);
      });
    }

    // ===== CELL RESIZING =====
    function makeCellsResizable() {
      const table = document.getElementById('iaTable');
      if (!table) return;

      const tbody = table.querySelector('tbody');
      if (!tbody) return;

      const cells = tbody.querySelectorAll('td');

      cells.forEach(cell => {
        const handleRight = cell.querySelector('.cell-resize-right');
        const handleBottom = cell.querySelector('.cell-resize-bottom');
        const handleCorner = cell.querySelector('.cell-resize-corner');

        // Right handle
        if (handleRight) {
          if (handleRight._handler) handleRight.removeEventListener('mousedown', handleRight._handler);

          const onMouseDown = (e) => {
            e.preventDefault();
            e.stopPropagation();

            const startX = e.pageX;
            const startWidth = cell.offsetWidth;
            let isResizing = true;

            cell.classList.add('resizing-cell');
            document.body.classList.add('resizing-active');

            const onMouseMove = (e) => {
              if (!isResizing) return;
              e.preventDefault();
              e.stopPropagation();

              const deltaX = e.pageX - startX;
              const newWidth = Math.max(40, startWidth + deltaX);
              
              cell.style.width = newWidth + 'px';
              cell.style.minWidth = newWidth + 'px';
            };

            const onMouseUp = () => {
              if (!isResizing) return;
              isResizing = false;
              
              cell.classList.remove('resizing-cell');
              document.body.classList.remove('resizing-active');
              
              document.removeEventListener('mousemove', onMouseMove, true);
              document.removeEventListener('mouseup', onMouseUp, true);
            };

            document.addEventListener('mousemove', onMouseMove, true);
            document.addEventListener('mouseup', onMouseUp, true);
          };

          handleRight._handler = onMouseDown;
          handleRight.addEventListener('mousedown', onMouseDown);
        }

        // Bottom handle
        if (handleBottom) {
          if (handleBottom._handler) handleBottom.removeEventListener('mousedown', handleBottom._handler);

          const onMouseDown = (e) => {
            e.preventDefault();
            e.stopPropagation();

            const startY = e.pageY;
            const startHeight = cell.offsetHeight;
            let isResizing = true;

            cell.classList.add('resizing-cell');
            document.body.classList.add('resizing-active');

            const onMouseMove = (e) => {
              if (!isResizing) return;
              e.preventDefault();
              e.stopPropagation();

              const deltaY = e.pageY - startY;
              const newHeight = Math.max(30, startHeight + deltaY);
              
              cell.style.height = newHeight + 'px';
              cell.style.minHeight = newHeight + 'px';
            };

            const onMouseUp = () => {
              if (!isResizing) return;
              isResizing = false;
              
              cell.classList.remove('resizing-cell');
              document.body.classList.remove('resizing-active');
              
              document.removeEventListener('mousemove', onMouseMove, true);
              document.removeEventListener('mouseup', onMouseUp, true);
            };

            document.addEventListener('mousemove', onMouseMove, true);
            document.addEventListener('mouseup', onMouseUp, true);
          };

          handleBottom._handler = onMouseDown;
          handleBottom.addEventListener('mousedown', onMouseDown);
        }

        // Corner handle
        if (handleCorner) {
          if (handleCorner._handler) handleCorner.removeEventListener('mousedown', handleCorner._handler);

          const onMouseDown = (e) => {
            e.preventDefault();
            e.stopPropagation();

            const startX = e.pageX;
            const startY = e.pageY;
            const startWidth = cell.offsetWidth;
            const startHeight = cell.offsetHeight;
            let isResizing = true;

            cell.classList.add('resizing-cell');
            document.body.classList.add('resizing-active');

            const onMouseMove = (e) => {
              if (!isResizing) return;
              e.preventDefault();
              e.stopPropagation();
              
              const deltaX = e.pageX - startX;
              const deltaY = e.pageY - startY;
              
              const newWidth = Math.max(40, startWidth + deltaX);
              const newHeight = Math.max(30, startHeight + deltaY);

              cell.style.width = newWidth + 'px';
              cell.style.height = newHeight + 'px';
              cell.style.minWidth = newWidth + 'px';
              cell.style.minHeight = newHeight + 'px';
            };

            const onMouseUp = () => {
              if (!isResizing) return;
              isResizing = false;
              
              cell.classList.remove('resizing-cell');
              document.body.classList.remove('resizing-active');
              
              document.removeEventListener('mousemove', onMouseMove, true);
              document.removeEventListener('mouseup', onMouseUp, true);
            };

            document.addEventListener('mousemove', onMouseMove, true);
            document.addEventListener('mouseup', onMouseUp, true);
          };

          handleCorner._handler = onMouseDown;
          handleCorner.addEventListener('mousedown', onMouseDown);
        }
      });
    }

    // ===== MODAL FUNCTIONS =====
    function openDetailModal(index) {
      const ia = AppState.filteredData[index];
      document.getElementById('modalTitle').textContent = ia.name || 'Détails';
      let html = '';
      const fields = getAllFields();
      fields.forEach(field => {
        const val = ia[field];
        const str = (typeof val === 'object') ? JSON.stringify(val, null, 2) : String(val || '');
        html += `
          <div class="field-group">
            <label>${escapeHtml(field)}</label>
            <textarea data-field="${escapeHtml(field)}" data-index="${index}">${escapeHtml(str)}</textarea>
          </div>
        `;
      });
      html += `<div style="display:flex;gap:12px;margin-top:16px;">
        <button class="btn-save" style="flex:1;padding:12px;border-radius:8px;background:var(--accent-primary);color:white;border:none;cursor:pointer;font-weight:600;transition:all 0.2s;" onclick="saveDetailChanges(${index})" onmouseover="this.style.background='var(--accent-secondary)'" onmouseout="this.style.background='var(--accent-primary)'">💾 Enregistrer</button>
        <button class="btn-delete" style="flex:1;padding:12px;border-radius:8px;background:var(--danger);color:white;border:none;cursor:pointer;font-weight:600;transition:all 0.2s;" onclick="closeModal()" onmouseover="this.style.background='#dc2626'" onmouseout="this.style.background='var(--danger)'">✕ Annuler</button>
      </div>`;
      modalBody.innerHTML = html;
      detailModal.classList.add('show');
      detailModal.setAttribute('aria-hidden', 'false');
    }

    function closeModal() {
      detailModal.classList.remove('show');
      detailModal.setAttribute('aria-hidden', 'true');
    }

    function saveDetailChanges(index) {
      const inputs = modalBody.querySelectorAll(`[data-index="${index}"]`);
      const updated = { ...AppState.filteredData[index] };
      inputs.forEach(inp => {
        const field = inp.dataset.field;
        let value = inp.value;
        try {
          if ((value.startsWith('{') || value.startsWith('['))) {
            value = JSON.parse(value);
          }
        } catch (e) {}
        updated[field] = value;
      });
      updated.updatedAt = new Date().toISOString().split('T')[0];
      const origIdx = AppState.iaData.findIndex(it => it.id === updated.id);
      if (origIdx !== -1) {
        AppState.iaData[origIdx] = updated;
      } else {
        AppState.iaData.push(updated);
      }
      AppState.isDirty = true;
      saveDraftLocal();
      applyFilters();
      showMsg('Changements enregistrés', 'success', 2000);
      closeModal();
    }

    // ===== CRUD OPERATIONS =====
    function confirmDelete(index) {
      const ia = AppState.filteredData[index];
      if (!ia) return;
      if (confirm(`Supprimer "${ia.name || ia.id || 'élément'}" ?`)) {
        deleteIA(index);
      }
    }

    function deleteIA(index) {
      const ia = AppState.filteredData[index];
      const origIdx = AppState.iaData.findIndex(it => it.id === ia.id);
      if (origIdx !== -1) AppState.iaData.splice(origIdx, 1);
      AppState.isDirty = true;
      saveDraftLocal();
      applyFilters();
      showMsg(`"${ia.name || ia.id}" supprimée`, 'success', 2000);
    }

    function addIA() {
      const newIA = {
        id: 'new-' + Date.now(),
        slug: 'new-slug-' + Date.now(),
        name: 'Nouvelle IA',
        short: '',
        description: '',
        categories: [],
        status: 'draft',
        featured: false,
        updatedAt: new Date().toISOString().split('T')[0]
      };
      AppState.iaData.unshift(newIA);
      AppState.isDirty = true;
      saveDraftLocal();
      applyFilters();
      showMsg('Nouvelle IA ajoutée', 'success', 1500);
    }

    function exportJSON() {
      const dataStr = JSON.stringify(AppState.iaData, null, 2);
      const blob = new Blob([dataStr], { type: 'application/json;charset=utf-8' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `ia-data-${new Date().toISOString().split('T')[0]}.json`;
      a.click();
      URL.revokeObjectURL(url);
      showMsg('Fichier exporté', 'success', 1500);
    }

    async function saveAll() {
      if (CONFIG.GITHUB.token) {
        await saveToGitHub(AppState.iaData);
      } else {
        showMsg('💾 Sauvegarde locale...', 'warning', 0);
        await saveDraftLocal();
        AppState.isDirty = false;
        updateStats();
        showMsg('✅ Données sauvegardées localement (IndexedDB)', 'success', 3000);
      }
    }

    // ===== GITHUB SAVE =====
    async function saveToGitHub(data) {
      const cfg = CONFIG.GITHUB;
      if (!cfg.token) {
        showMsg('❌ Token GitHub manquant', 'error', 5000);
        return;
      }

      showMsg('💾 Sauvegarde sur GitHub en cours...', 'warning', 0);

      try {
        const res = await fetch(`https://api.github.com/repos/${cfg.repoOwner}/${cfg.repoName}/contents/${cfg.filePath}`, {
          headers: { 
            Authorization: `token ${cfg.token}`,
            'Content-Type': 'application/json'
          }
        });
        
        if (!res.ok) throw new Error(`Impossible de récupérer le fichier (HTTP ${res.status})`);
        const file = await res.json();

        const content = btoa(unescape(encodeURIComponent(JSON.stringify(data, null, 2))));

        const updateRes = await fetch(`https://api.github.com/repos/${cfg.repoOwner}/${cfg.repoName}/contents/${cfg.filePath}`, {
          method: 'PUT',
          headers: {
            Authorization: `token ${cfg.token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            message: `🔄 Mise à jour via Admin (${new Date().toLocaleString('fr-FR')})`,
            content,
            sha: file.sha,
            branch: cfg.branch
          })
        });

        if (!updateRes.ok) {
          const errorData = await updateRes.json();
          throw new Error(`Erreur GitHub: ${errorData.message || updateRes.status}`);
        }
        
        AppState.isDirty = false;
        updateStats();
        showMsg('✅ Sauvegardé sur GitHub avec succès !', 'success', 4000);

      } catch (err) {
        console.error('Erreur GitHub:', err);
        showMsg('❌ Erreur GitHub: ' + err.message, 'error', 6000);
      }
    }

    // ===== TABLE CHANGE HANDLER =====
    function handleTableChange(e) {
      if (!e.target.dataset.field) return;
      const field = e.target.dataset.field;
      const index = parseInt(e.target.dataset.index);
      let value = e.target.value;
      if (e.target.type === 'checkbox') value = e.target.checked;
      else if (e.target.type === 'number') value = parseFloat(value) || 0;

      AppState.filteredData[index][field] = value;
      AppState.filteredData[index].updatedAt = new Date().toISOString().split('T')[0];

      const origIdx = AppState.iaData.findIndex(ia => ia.id === AppState.filteredData[index].id);
      if (origIdx !== -1) AppState.iaData[origIdx] = AppState.filteredData[index];

      AppState.isDirty = true;
      saveDraftLocal();
      updateStats();
    }

    // ===== EVENT LISTENERS =====
    function setupEventListeners() {
      document.getElementById('addIA')?.addEventListener('click', addIA);
      document.getElementById('exportJSON')?.addEventListener('click', exportJSON);
      document.getElementById('saveAll')?.addEventListener('click', saveAll);
      document.getElementById('refreshData')?.addEventListener('click', () => {
        if (confirm('Rafraîchir ? Vous perdrez vos brouillons locaux.')) {
          AppState.columnFilters = {};
          loadData();
          AppState.isDirty = false;
        }
      });

      searchInput?.addEventListener('input', () => {
        clearTimeout(searchInput._t);
        searchInput._t = setTimeout(() => applyFilters(), 180);
      });

      categorySelect?.addEventListener('change', () => {
        const val = categorySelect.value;
        document.querySelectorAll('#categoryFilters .filter-btn').forEach(b =>
          b.classList.toggle('active', b.dataset.cat === val)
        );
        applyFilters();
      });

      tableBody?.addEventListener('input', handleTableChange);
      tableBody?.addEventListener('change', handleTableChange);

      document.getElementById('closeModalBtn')?.addEventListener('click', closeModal);
      detailModal?.addEventListener('click', (e) => {
        if (e.target === detailModal) closeModal();
      });
    }

    // ===== CATEGORY RENDERING =====
    function renderCategorySelect() {
      if (!categorySelect) return;
      const cats = new Set(AppState.iaData.flatMap(ia => ia.categories || []));
      categorySelect.innerHTML = '<option value="">Toutes catégories</option>';
      Array.from(cats).sort().forEach(c => {
        const opt = document.createElement('option');
        opt.value = c;
        opt.textContent = c;
        categorySelect.appendChild(opt);
      });
    }

    function renderCategoryQuickButtons() {
      if (!categoryFiltersDiv) return;
      const cats = new Set(AppState.iaData.flatMap(ia => ia.categories || []));
      
      const label = categoryFiltersDiv.querySelector('.category-filters-label');
      categoryFiltersDiv.innerHTML = '';
      if (label) categoryFiltersDiv.appendChild(label.cloneNode(true));

      const allBtn = document.createElement('button');
      allBtn.className = 'filter-btn active';
      allBtn.dataset.cat = '';
      allBtn.textContent = 'Toutes';
      categoryFiltersDiv.appendChild(allBtn);

      allBtn.addEventListener('click', () => {
        document.querySelectorAll('#categoryFilters .filter-btn').forEach(b => b.classList.remove('active'));
        allBtn.classList.add('active');
        if (categorySelect) categorySelect.value = '';
        applyFilters();
      });

      Array.from(cats).sort().slice(0, 15).forEach(c => {
        const btn = document.createElement('button');
        btn.className = 'filter-btn';
        btn.dataset.cat = c;
        btn.textContent = c;
        btn.addEventListener('click', () => {
          document.querySelectorAll('#categoryFilters .filter-btn').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          if (categorySelect) categorySelect.value = c;
          applyFilters();
        });
        categoryFiltersDiv.appendChild(btn);
      });
    }

    // ===== GLOBAL EXPORTS =====
    window.openDetailModal = openDetailModal;
    window.closeModal = closeModal;
    window.saveDetailChanges = saveDetailChanges;
    window.confirmDelete = confirmDelete;
    window.deleteIA = deleteIA;
  </script>
</body>
</html>
